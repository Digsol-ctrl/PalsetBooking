<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Book a Ride</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/payments.css' %}">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initPlaceAutocomplete"></script>
</head>
<body>
<h1>Book a Ride</h1>
<form id="bookingForm" method="post" action="">
    {% csrf_token %}
    <div class="form-row">
        <label>Pickup</label><br>
        <input id="pickup" name="pickup_address" placeholder="Pickup location" size="60" required>
        <input type="hidden" id="pickup_lat" name="pickup_lat" />
        <input type="hidden" id="pickup_lng" name="pickup_lng" />
    </div>
    <div class="form-row">
        <label>Dropoff</label><br>
        <input id="dropoff" name="dropoff_address" placeholder="Dropoff location" size="60" required>
        <input type="hidden" id="dropoff_lat" name="dropoff_lat" />
        <input type="hidden" id="dropoff_lng" name="dropoff_lng" />
    </div>
    <div class="form-row">
        <label>Distance (km)</label><br>
        <input id="distance" name="distance_km" type="number" step="0.01" placeholder="Leave empty to calculate automatically">
    </div>

    <div class="form-row">
        <label>Adults</label>
        <input name="num_adults" type="number" value="1" min="1">
    </div>

    <div class="form-row">
        <label>Kids (seated)</label>
        <input name="num_kids_seated" type="number" value="0" min="0">
    </div>

    <div class="form-row">
        <label>Kids (carried)</label>
        <input name="num_kids_carried" type="number" value="0" min="0">
    </div>

    <div class="form-row">
        <label>Luggage bags</label>
        <input name="luggage_count" type="number" value="0" min="0">
    </div>

    <div class="form-row">
        <label>Phone</label>
        <input name="phone" required>
    </div>
    <div class="form-row">
        <label>Email</label>
        <input name="email" type="email" required>
    </div>

    <div class="form-row payment-row">
        <label>Payment</label>
        <div class="payment-options" role="radiogroup" aria-label="Payment method">
            <label class="radio"><input type="radio" name="payment_option" value="POA" checked> Pay on Arrival</label>
            <label class="radio"><input type="radio" name="payment_option" value="PAYNOW"> Pay Online (Paynow)</label>
        </div>
    </div>

    <button type="submit" class="btn primary">Book</button>
</form>

  <h3>Fare preview</h3>
  <div id="fare_preview" class="fare-preview" aria-live="polite">Enter trip details to see a fare estimate</div>

<script>
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

function initPlaceAutocomplete() {
    try{
      var pickup = document.getElementById('pickup');
      var dropoff = document.getElementById('dropoff');

      if (!window.google || !google.maps || !google.maps.places) {
        console.warn('Google Places not available');
        return;
      }

      function attach(el, latId, lngId){
        if(!el) return;

        // Use the newer PlaceAutocompleteElement only. If it's not present,
        // alert the developer and show guidance instead of calling legacy APIs.
        if('PlaceAutocompleteElement' in google.maps.places){
          const elem = new google.maps.places.PlaceAutocompleteElement({input: el, fields: ['geometry']});
          elem.addListener('place_changed', function(){
            const place = elem.getPlace();
            if(place && place.geometry){
              document.getElementById(latId).value = place.geometry.location.lat();
              document.getElementById(lngId).value = place.geometry.location.lng();
              schedulePreview();
            }
          });
        } else {
          // Show a friendly message in the fare preview area and a console hint
          const msg = 'Autocomplete unavailable: please enable the new Places API (PlaceAutocompleteElement) for your API key in Google Cloud Console or use a key with Places (New) access.';
          console.warn(msg);
          const previewEl = document.getElementById('fare_preview');
          if(previewEl) previewEl.innerText = msg;
        }
      }

      attach(pickup, 'pickup_lat', 'pickup_lng');
      attach(dropoff, 'dropoff_lat', 'dropoff_lng');

      var distEl = document.getElementById('distance');
      if(distEl) distEl.placeholder = 'Leave empty to calculate automatically';

    } catch(e){ console.warn('Error initializing place autocomplete', e) }
}

// Initialization is performed after the Maps JS loader resolves above.

// Debounce utility
function debounce(fn, wait){
  let t = null;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=>fn.apply(this, args), wait);
  };
}

async function fetchFarePreview(payload){
  try{
    const resp = await fetch('/rides/api/price/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const err = await resp.json().catch(()=>({detail:'Error'}));
      document.getElementById('fare_preview').innerText = 'Unable to estimate fare: ' + (err.detail || resp.statusText);
      return;
    }

    const data = await resp.json();
    renderPreview(data);
  }catch(e){
    console.warn('Preview error', e);
    document.getElementById('fare_preview').innerText = 'Unable to estimate fare (network error)';
  }
}

function renderPreview(data){
  const el = document.getElementById('fare_preview');
  el.innerHTML = `
    <strong>Estimated fare: $${data.total.toFixed(2)}</strong><br/>
    <small>Distance: ${data.distance_km} km (effective ${data.effective_distance_km} km)</small>
    <ul>
      <li>Base distance price: $${data.base_distance_price.toFixed(2)}</li>
      <li>Extra adults: ${data.extra_adults} → $${data.extra_adults_fee.toFixed(2)}</li>
      <li>Kids seated: ${data.kids_seated} → $${data.kids_seated_fee.toFixed(2)}</li>
      <li>Luggage: ${data.luggage_count} → $${data.luggage_fee.toFixed(2)}</li>
    </ul>
  `;
}

function gatherPayload(){
  const distance = document.getElementById('distance').value;
  const payload = {
    distance_km: distance ? parseFloat(distance) : null,
    pickup_lat: parseFloat(document.getElementById('pickup_lat').value) || null,
    pickup_lng: parseFloat(document.getElementById('pickup_lng').value) || null,
    dropoff_lat: parseFloat(document.getElementById('dropoff_lat').value) || null,
    dropoff_lng: parseFloat(document.getElementById('dropoff_lng').value) || null,
    num_adults: parseInt(document.querySelector('[name="num_adults"]').value) || 1,
    num_kids_seated: parseInt(document.querySelector('[name="num_kids_seated"]').value) || 0,
    num_kids_carried: parseInt(document.querySelector('[name="num_kids_carried"]').value) || 0,
    luggage_count: parseInt(document.querySelector('[name="luggage_count"]').value) || 0,
  };
  return payload;
}

const schedulePreview = debounce(()=>{
  const payload = gatherPayload();
  // If distance missing and coordinates missing, skip
  if(!payload.distance_km && (!payload.pickup_lat || !payload.pickup_lng || !payload.dropoff_lat || !payload.dropoff_lng)){
    document.getElementById('fare_preview').innerText = 'Enter addresses or distance to preview fare';
    return;
  }
  document.getElementById('fare_preview').innerText = 'Calculating...';
  fetchFarePreview(payload);
}, 600);

// Attach listeners
['distance','pickup_lat','pickup_lng','dropoff_lat','dropoff_lng'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', schedulePreview);
});

['num_adults','num_kids_seated','num_kids_carried','luggage_count'].forEach(name=>{
  const el = document.querySelector('[name="'+name+'"]');
  if(el) el.addEventListener('change', schedulePreview);
});

// initial preview attempt
schedulePreview();
