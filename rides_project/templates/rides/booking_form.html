<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Book a Ride</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/payments.css' %}?v=2">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_CLIENT_KEY }}&libraries=places&callback=initPlaceAutocomplete"></script>
</head>
<body>
<main class="container">
  <header class="page-header">
    <h1 class="page-title">Book a Ride</h1>
    <p class="lead">Fast, affordable rides — enter pickup and dropoff to get started</p>
  </header>

  <form id="bookingForm" class="booking-form" method="post" action="" novalidate>
    {% csrf_token %}

    <div class="form-row">
      <label for="pickup">Pickup</label>
      <input id="pickup" name="pickup_address" placeholder="Pickup location" class="input" required aria-required="true" autocomplete="street-address">
      <input type="hidden" id="pickup_lat" name="pickup_lat" />
      <input type="hidden" id="pickup_lng" name="pickup_lng" />
    </div>

    <div class="form-row">
      <label for="dropoff">Dropoff</label>
      <input id="dropoff" name="dropoff_address" placeholder="Dropoff location" class="input" required aria-required="true" autocomplete="street-address">
      <input type="hidden" id="dropoff_lat" name="dropoff_lat" />
      <input type="hidden" id="dropoff_lng" name="dropoff_lng" />
    </div>

    <div class="form-row two-up">
      <div>
        <label for="distance">Distance (km)</label>
        <input id="distance" class="input" name="distance_km" type="number" step="0.01" placeholder="Leave empty to calculate automatically" inputmode="decimal">
      </div>
      <div>
        <label for="num_adults">Adults</label>
        <input id="num_adults" class="input" name="num_adults" type="number" value="1" min="1" inputmode="numeric">
      </div>
    </div>

    <div class="form-row two-up">
      <div>
        <label for="num_kids_seated">Kids (seated)</label>
        <input id="num_kids_seated" class="input" name="num_kids_seated" type="number" value="0" min="0" inputmode="numeric">
      </div>
      <div>
        <label for="num_kids_carried">Kids (carried)</label>
        <input id="num_kids_carried" class="input" name="num_kids_carried" type="number" value="0" min="0" inputmode="numeric">
      </div>
    </div>

    <div class="form-row two-up">
      <div>
        <label for="luggage_count">Luggage bags</label>
        <input id="luggage_count" class="input" name="luggage_count" type="number" value="0" min="0" inputmode="numeric">
      </div>
      <div>
        <label for="phone">Phone</label>
        <input id="phone" class="input" name="phone" type="tel" required inputmode="tel">
      </div>
    </div>

    <div class="form-row">
      <label for="email">Email</label>
      <input id="email" class="input" name="email" type="email" required inputmode="email">
    </div>

    <div class="form-row payment-row">
      <fieldset class="payment-fieldset" role="radiogroup" aria-label="Payment method">
        <legend class="sr-only">Payment method</legend>
        <label class="radio large"><input type="radio" name="payment_option" value="POA" checked> <span>Pay on Arrival</span></label>
        <label class="radio large"><input type="radio" name="payment_option" value="PAYNOW"> <span>Pay Online (Paynow)</span></label>
      </fieldset>
    </div>

    <div class="form-row">
      <button type="submit" class="btn primary" id="submitBtn" aria-live="polite">Book</button>
    </div>
  </form>

  <h3>Fare preview</h3>
  <div id="fare_preview" class="fare-preview" aria-live="polite">Enter trip details to see a fare estimate</div>

  <script>
    // Prevent double-submit and give immediate feedback
    (function(){
      var form = document.getElementById('bookingForm');
      var submit = document.getElementById('submitBtn');
      if(!form || !submit) return;
      form.addEventListener('submit', function(){
        submit.disabled = true;
        submit.classList.add('loading');
        submit.setAttribute('aria-busy', 'true');
        submit.textContent = 'Booking…';
      });
    })();
  </script>
</main>

<script>
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}

function initPlaceAutocomplete() {
    try{
      var pickup = document.getElementById('pickup');
      var dropoff = document.getElementById('dropoff');

      if (!window.google || !google.maps || !google.maps.places) {
        console.warn('Google Places not available');
        return;
      }

      function attach(el, latId, lngId){
        if(!el) return;

        // Use the newer PlaceAutocompleteElement only. If it's not present,
        // alert the developer and show guidance instead of calling legacy APIs.
        if('PlaceAutocompleteElement' in google.maps.places){
          const elem = new google.maps.places.PlaceAutocompleteElement({input: el, fields: ['geometry']});
          elem.addListener('place_changed', function(){
            const place = elem.getPlace();
            if(place && place.geometry){
              document.getElementById(latId).value = place.geometry.location.lat();
              document.getElementById(lngId).value = place.geometry.location.lng();
              schedulePreview();
            }
          });
        } else {
          // Show a friendly message in the fare preview area and a console hint
          const msg = 'Autocomplete unavailable: please enable the new Places API (PlaceAutocompleteElement) for your API key in Google Cloud Console or use a key with Places (New) access.';
          console.warn(msg);
          const previewEl = document.getElementById('fare_preview');
          if(previewEl) previewEl.innerText = msg;
        }
      }

      attach(pickup, 'pickup_lat', 'pickup_lng');
      attach(dropoff, 'dropoff_lat', 'dropoff_lng');

      var distEl = document.getElementById('distance');
      if(distEl) distEl.placeholder = 'Leave empty to calculate automatically';

    } catch(e){ console.warn('Error initializing place autocomplete', e) }
}

// Initialization is performed after the Maps JS loader resolves above.

// Debounce utility
function debounce(fn, wait){
  let t = null;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=>fn.apply(this, args), wait);
  };
}

async function fetchFarePreview(payload){
  try{
    const resp = await fetch('{% url "rides:price_estimate" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const err = await resp.json().catch(()=>({detail:'Error'}));
      document.getElementById('fare_preview').innerText = 'Unable to estimate fare: ' + (err.detail || resp.statusText);
      return;
    }

    const data = await resp.json();
    renderPreview(data);
  }catch(e){
    console.warn('Preview error', e);
    document.getElementById('fare_preview').innerText = 'Unable to estimate fare (network error)';
  }
}

function renderPreview(data){
  const el = document.getElementById('fare_preview');
  el.innerHTML = `
    <strong>Estimated fare: $${data.total.toFixed(2)}</strong><br/>
    <small>Distance: ${data.distance_km} km (effective ${data.effective_distance_km} km)</small>
    <ul>
      <li>Base distance price: $${data.base_distance_price.toFixed(2)}</li>
      <li>Extra adults: ${data.extra_adults} → $${data.extra_adults_fee.toFixed(2)}</li>
      <li>Kids seated: ${data.kids_seated} → $${data.kids_seated_fee.toFixed(2)}</li>
      <li>Luggage: ${data.luggage_count} → $${data.luggage_fee.toFixed(2)}</li>
    </ul>
  `;
}

function gatherPayload(){
  const distance = document.getElementById('distance').value;
  const payload = {
    distance_km: distance ? parseFloat(distance) : null,
    pickup_lat: parseFloat(document.getElementById('pickup_lat').value) || null,
    pickup_lng: parseFloat(document.getElementById('pickup_lng').value) || null,
    dropoff_lat: parseFloat(document.getElementById('dropoff_lat').value) || null,
    dropoff_lng: parseFloat(document.getElementById('dropoff_lng').value) || null,
    num_adults: parseInt(document.querySelector('[name="num_adults"]').value) || 1,
    num_kids_seated: parseInt(document.querySelector('[name="num_kids_seated"]').value) || 0,
    num_kids_carried: parseInt(document.querySelector('[name="num_kids_carried"]').value) || 0,
    luggage_count: parseInt(document.querySelector('[name="luggage_count"]').value) || 0,
  };
  return payload;
}

const schedulePreview = debounce(()=>{
  const payload = gatherPayload();
  // If distance missing and coordinates missing, skip
  if(!payload.distance_km && (!payload.pickup_lat || !payload.pickup_lng || !payload.dropoff_lat || !payload.dropoff_lng)){
    document.getElementById('fare_preview').innerText = 'Enter addresses or distance to preview fare';
    return;
  }
  document.getElementById('fare_preview').innerText = 'Calculating...';
  fetchFarePreview(payload);
}, 600);

// Attach listeners
['distance','pickup_lat','pickup_lng','dropoff_lat','dropoff_lng'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', schedulePreview);
});

['num_adults','num_kids_seated','num_kids_carried','luggage_count'].forEach(name=>{
  const el = document.querySelector('[name="'+name+'"]');
  if(el) el.addEventListener('change', schedulePreview);
});

// initial preview attempt
schedulePreview();
