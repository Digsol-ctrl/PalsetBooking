<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Redirecting to Paynow</title>
  <style>.btn{padding:8px 12px;background:#007acc;color:#fff;border:none;border-radius:4px;text-decoration:none}</style>
</head>
<body>
  <h1>Redirecting to payment</h1>
  {% if redirect_url and redirect_is_valid %}
    <p>If you are not redirected automatically <a id="link" class="btn" href="{{ redirect_url }}" target="_blank">click here to pay</a></p>
    <script>window.location.href = "{{ redirect_url }}";</script>
  {% elif redirect_url %}
    <p>Paynow returned an invalid redirect URL: <code>{{ redirect_url|escape }}</code></p>
    <p>{{ message }}</p>
  {% else %}
    <p>{{ message }}</p>
  {% endif %}

  {% if payment_id and booking_id %}
    <hr />
    <p>You can check your payment status here — this page will update automatically:</p>
    <div id="status-text" style="color:#666">Checking…</div>
    <button id="check-now" class="btn">Check now</button>
    <script>
      (function(){
        const paymentId = "{{ payment_id }}";
        const bookingId = "{{ booking_id }}";
        const statusEl = document.getElementById('status-text');
        const checkUrl = `/rides/paynow/poll/${paymentId}/`;

        async function checkStatus(){
          try{
            const res = await fetch(checkUrl, {cache:'no-cache'});
            if(!res.ok){ statusEl.textContent = 'Check failed: ' + res.status; return; }
            const json = await res.json();
            if(json.paid){ statusEl.textContent = 'Payment confirmed — redirecting...'; window.location.href = `/rides/bookings/success/${bookingId}/`; }
            else{ statusEl.textContent = 'Pending: ' + (json.status || 'pending'); }
          }catch(e){ statusEl.textContent = 'Error checking status: ' + e.message; }
        }

        document.getElementById('check-now').addEventListener('click', checkStatus);
        // start background polling
        const t = setInterval(checkStatus, 5000);
        checkStatus();
      })();
    </script>
  {% endif %}
</body>
</html>