{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Redirecting to Paynow</title>
  <link rel="stylesheet" href="{% static 'css/payments.css' %}">
</head>
<body>
  <main class="container">
    <header class="page-header">
      <h1 class="page-title">Redirecting to payment</h1>
      <p class="lead">You'll be taken to Paynow to complete your payment. If nothing happens, use the button below.</p>
    </header>

    {% if redirect_url and redirect_is_valid %}
      <p><a id="open-paynow" class="btn primary" href="{{ redirect_url }}" target="_blank" rel="noopener">Open Paynow to pay</a></p>
      <p class="small u-muted">If your browser blocks the redirect, tap the button above.</p>
      <script>
        (function(){
          try{ window.location.href = "{{ redirect_url }}"; }catch(e){ /* ignore */ }
        })();
      </script>
    {% elif redirect_url %}
      <div class="success-card">
        <p class="error"><strong>Invalid redirect URL:</strong> <code>{{ redirect_url|escape }}</code></p>
        <p>{{ message }}</p>
      </div>
    {% else %}
      <div class="success-card"><p>{{ message }}</p></div>
    {% endif %}

    {% if payment_id and booking_id %}
      <hr />
      <p>You can check your payment status here:</p>
      <div id="status-text" class="u-muted">Checking…</div>
      <div style="margin-top:12px"><button id="check-now" class="btn">Check now</button></div>
      <script>
        (function(){
          const statusEl = document.getElementById('status-text');
          const checkUrl = `/rides/paynow/poll/{{ payment_id }}/`;

          async function checkStatus(){
            try{
              const res = await fetch(checkUrl, {cache:'no-cache'});
              if(!res.ok){ statusEl.textContent = 'Check failed: ' + res.status; return; }
              const json = await res.json();
              if(json.paid){ statusEl.textContent = 'Payment confirmed — redirecting...'; window.location.href = `/rides/bookings/success/{{ booking_id }}/`; }
              else{ statusEl.textContent = 'Pending: ' + (json.status || 'pending'); }
            }catch(e){ statusEl.textContent = 'Error checking status'; }
          }

          document.getElementById('check-now').addEventListener('click', checkStatus);
          const t = setInterval(checkStatus, 5000);
          checkStatus();
        })();
      </script>
    {% endif %}
  </main>
</body>
</html>